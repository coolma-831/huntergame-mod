name: Build Minecraft Mod

on:
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and Upload Mod
    
    steps:
    # 1. 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. 设置 Java 环境
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    # 3. 设置 Forge 开发环境
    - name: Setup Forge environment
      run: |
        # 创建完整的项目结构
        mkdir -p src/main/java/com/example/huntergame
        mkdir -p src/main/resources/META-INF
        mkdir -p gradle/wrapper
        
        # 创建必要的 Gradle 文件
        cat > build.gradle << 'EOL'
        plugins {
            id 'net.minecraftforge.gradle' version '5.1.44'
        }
        
        version = '1.0'
        group = 'com.example.huntergame'
        archivesBaseName = 'huntergame'
        
        java.toolchain.languageVersion = JavaLanguageVersion.of(17)
        
        minecraft {
            mappings channel: 'official', version: '1.20.1'
            
            runs {
                client {
                    workingDirectory project.file('run')
                    property 'forge.logging.console.level', 'debug'
                    mods {
                        huntergame {
                            source sourceSets.main
                        }
                    }
                }
            }
        }
        
        dependencies {
            minecraft 'net.minecraftforge:forge:1.20.1-47.1.0'
        }
        
        jar {
            manifest {
                attributes([
                    "Specification-Title": "huntergame",
                    "Specification-Version": "1",
                    "Implementation-Title": project.name,
                    "Implementation-Version": "1.0",
                    "Implementation-Timestamp": new Date().format("yyyy-MM-dd'T'HH:mm:ssZ")
                ])
            }
        }
        
        // 确保包含资源文件
        processResources {
            from('src/main/resources') {
                include '**'
            }
        }
        EOL
        
        cat > settings.gradle << 'EOL'
        rootProject.name = 'huntergame-mod'
        EOL
        
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOL'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-7.5.1-bin.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOL
        
        # 创建必要的资源文件
        cat > src/main/resources/META-INF/mods.toml << 'EOL'
        modLoader="javafml"
        loaderVersion="[47,)"
        license="All Rights Reserved"
        [[mods]]
        modId="huntergame"
        version="1.0"
        displayName="猎人游戏"
        description="猎人追逐逃生者的游戏模式"
        authors="YourName"
        EOL
        
        cat > src/main/resources/META-INF/accesstransformer.cfg << 'EOL'
        # 空访问转换器文件
        EOL
        
        echo "Forge 开发环境设置完成"
    
    # 4. 初始化 Gradle Wrapper
    - name: Initialize Gradle Wrapper
      run: |
        # 下载 Gradle Wrapper JAR
        wget -q https://github.com/gradle/gradle/raw/v7.5.1/gradle/wrapper/gradle-wrapper.jar -P gradle/wrapper/
        
        # 创建 gradlew 脚本
        cat > gradlew << 'EOL'
        #!/bin/sh
        
        # 查找 Java 可执行文件
        if [ -n "$JAVA_HOME" ] ; then
            if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
                JAVACMD="$JAVA_HOME/jre/sh/java"
            else
                JAVACMD="$JAVA_HOME/bin/java"
            fi
        else
            JAVACMD="java"
        fi
        
        # 设置 wrapper JAR 路径
        WRAPPER_JAR="gradle/wrapper/gradle-wrapper.jar"
        
        # 执行 Gradle
        exec "$JAVACMD" \
            -classpath "$WRAPPER_JAR" \
            org.gradle.wrapper.GradleWrapperMain \
            "$@"
        EOL
        
        # 添加执行权限
        chmod +x gradlew
        
        echo "Gradle Wrapper 初始化完成"
    
    # 5. 构建 Mod
    - name: Build Mod with Gradle
      run: |
        # 执行构建
        ./gradlew build --no-daemon --stacktrace
    
    # 6. 上传构建产物
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mod-artifact
        path: build/libs/*.jar
        retention-days: 5
    
    # 7. 添加调试信息
    - name: Debug file structure
      if: always()
      run: |
        echo "当前目录结构:"
        ls -la
        echo "Gradle 文件内容:"
        cat build.gradle
        cat settings.gradle
        cat gradle/wrapper/gradle-wrapper.properties
        echo "Gradle Wrapper 状态:"
        ./gradlew --version || true
